# .github/workflows/publish.yml

on:
  push:
    tags:
      - "v[0-9]+.[0-9]+.[0-9]+*" # åŒ¹é… vX.Y.Z æ ¼å¼çš„æ ‡ç­¾
  workflow_dispatch: # å…è®¸æ‰‹åŠ¨è§¦å‘

permissions:
  contents: write # éœ€è¦å†™æƒé™æ¥åˆ›å»º GitHub Release

jobs:
  create-packages:
    strategy:
      matrix:
        # å®šä¹‰æ„å»ºçŸ©é˜µï¼ŒåŒ…å«æ“ä½œç³»ç»Ÿã€æ¶æ„å’Œç”¨äºæ ‡è¯†çš„åç§°
        include:
          - os: ubuntu-latest
            arch: x64
            name: ubuntu-x64
          - os: windows-latest
            arch: x64
            name: windows-x64
          - os: macos-latest # é€šå¸¸æ˜¯ Intel (x64)
            arch: x64
            name: macos-x64
          - os: macos-14 # è¿™æ˜¯å½“å‰çš„ ARM64 (Apple Silicon) runner
            arch: arm64
            name: macos-arm64

    runs-on: ${{ matrix.os }} # æ ¹æ®çŸ©é˜µé€‰æ‹©è¿è¡Œå™¨
    steps:
      - name: ğŸ›’ Checkout # æ£€å‡ºä»£ç 
        uses: actions/checkout@v4 # æ›´æ–°åˆ° v4

      - name: â˜• Setup JDK 17 # è®¾ç½® Java ç¯å¢ƒ
        uses: actions/setup-java@v4
        with:
          distribution: "adopt"
          java-version: "17"
          architecture: ${{ matrix.arch }} # æ ¹æ®çŸ©é˜µé€‰æ‹© JDK æ¶æ„ (x64 æˆ– arm64)

      - name: âœ¨ Grant execute permission for gradlew # èµ‹äºˆ gradlew æ‰§è¡Œæƒé™
        # å¯¹äºé Windows ç³»ç»Ÿæ‰§è¡Œ chmod
        if: runner.os != 'Windows'
        run: chmod +x gradlew

      - name: ğŸ’¾ Cache Gradle Dependencies # ç¼“å­˜ Gradle ä¾èµ–
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          # ä½¿ç”¨æ›´å…·ä½“çš„ç¼“å­˜é”®ï¼ŒåŒ…å«æ“ä½œç³»ç»Ÿå’Œæ¶æ„
          key: ${{ matrix.name }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
          restore-keys: |
            ${{ matrix.name }}-gradle-
          enableCrossOsArchive: true # å…è®¸è·¨æ“ä½œç³»ç»Ÿæ¢å¤ç¼“å­˜ (å¯¹æŸäº›åœºæ™¯æœ‰å¸®åŠ©)

      - name: ğŸ› ï¸ Gradle Initial Run (Workaround) # Gradle é¦–æ¬¡è¿è¡Œ (ä¸´æ—¶è§£å†³ Compose æ’ä»¶é—®é¢˜)
        # å½“å‰ç‰ˆæœ¬çš„ Compose æ’ä»¶é¦–æ¬¡åˆå§‹åŒ– Gradle å¯èƒ½ä¼šå¤±è´¥
        # ç­‰å¾…æ­¤ bug ä¿®å¤åå¯ç§»é™¤ continue-on-error
        continue-on-error: true
        run: |
          ./gradlew
        # ä¿®æ­£: ä½¿ç”¨ä¸‰å…ƒè¿ç®—ç¬¦é€‰æ‹© shell
        shell: ${{ runner.os == 'Windows' ? 'pwsh' : 'bash' }} # <--- ä¿®æ­£è¿™é‡Œ (åŸ Line 65)

      - name: ğŸ“¦ Build package for current OS using gradle # ä½¿ç”¨ Gradle æ„å»ºåŒ…
        # ä¿®æ­£: ä½¿ç”¨ä¸‰å…ƒè¿ç®—ç¬¦é€‰æ‹© shell
        shell: ${{ runner.os == 'Windows' ? 'pwsh' : 'bash' }} # <--- ä¿®æ­£è¿™é‡Œ (åŸ Line 69)
        run: |
          ./gradlew desktop:app:createReleaseFolderForCi

      - name: ğŸ›‘ Release Gradle to unlock cache files # åœæ­¢ Gradle å®ˆæŠ¤è¿›ç¨‹ä»¥è§£é”ç¼“å­˜
        # ä¿®æ­£: ä½¿ç”¨ä¸‰å…ƒè¿ç®—ç¬¦é€‰æ‹© shell
        shell: ${{ runner.os == 'Windows' ? 'pwsh' : 'bash' }} # <--- ä¿®æ­£è¿™é‡Œ (æ¶‰åŠ ./gradlew çš„æ­¥éª¤éƒ½åº”æ£€æŸ¥)
        run: |
          ./gradlew --stop

      - name: â¬†ï¸ Upload output to artifacts # ä¸Šä¼ æ„å»ºäº§ç‰©
        uses: actions/upload-artifact@v4
        with:
          path: ./build/ci-release # æ„å»ºäº§ç‰©è·¯å¾„
          name: app-${{ matrix.name }} # ä½¿ç”¨åŒ…å«æ¶æ„çš„åç§°å‘½åäº§ç‰©

  release:
    runs-on: ubuntu-latest # å‘å¸ƒæ­¥éª¤åœ¨ Ubuntu ä¸Šè¿è¡Œ
    needs: ["create-packages"] # ä¾èµ–äºæ‰“åŒ…ä½œä¸š
    # ä»…å½“è§¦å‘äº‹ä»¶æ˜¯æ‰“æ ‡ç­¾æ—¶è¿è¡Œ
    if: startsWith(github.ref, 'refs/tags/v')
    steps:
      - name: â¬‡ï¸ Download All Artifacts # ä¸‹è½½æ‰€æœ‰æ„å»ºäº§ç‰©
        uses: actions/download-artifact@v4
        with:
          path: release # ä¸‹è½½åˆ° release ç›®å½•
          # ä½¿ç”¨é€šé…ç¬¦åŒ¹é…æ‰€æœ‰ app- å¼€å¤´çš„äº§ç‰©
          pattern: app-*
          merge-multiple: true # å°†æ‰€æœ‰åŒ¹é…çš„äº§ç‰©åˆå¹¶åˆ°åŒä¸€ç›®å½•

      - name: ğŸ·ï¸ Version Info # è·å–ç‰ˆæœ¬ä¿¡æ¯
        id: version
        uses: nowsprinting/check-version-format-action@v3
        with:
          prefix: "v" # ç‰ˆæœ¬å‰ç¼€

      - name: ğŸŒ³ Show the output tree of release # æ˜¾ç¤º release ç›®å½•ç»“æ„
        run: |
          tree release # éœ€è¦å®‰è£… tree å·¥å…· (ubuntu-latest é»˜è®¤åŒ…å«)

      - name: ğŸš€ Create GitHub Release # åˆ›å»º GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          # å¦‚æœä¸æ˜¯ç¨³å®šç‰ˆæœ¬ (ä¾‹å¦‚ v1.0.0-rc1)ï¼Œåˆ™æ ‡è®°ä¸ºé¢„å‘å¸ƒ
          prerelease: ${{ !steps.version.outputs.is_stable }}
          make_latest: legacy # æ ‡è®°ä¸º 'latest' release çš„ç­–ç•¥
          draft: true # åˆ›å»ºä¸ºè‰ç¨¿ï¼Œæ–¹ä¾¿æ‰‹åŠ¨æ£€æŸ¥å’Œå‘å¸ƒ
          files: |
            release/binaries/* # ä¸Šä¼  release/binaries ç›®å½•ä¸‹çš„æ‰€æœ‰æ–‡ä»¶
          body_path: release/release-notes.md # ä»æ–‡ä»¶è¯»å–å‘å¸ƒè¯´æ˜

      - name: ğŸ—‘ï¸ Remove artifacts to free space # åˆ é™¤æ„å»ºäº§ç‰©ä»¥é‡Šæ”¾ç©ºé—´
        uses: geekyeggo/delete-artifact@v5
        with:
          # ä½¿ç”¨é€šé…ç¬¦åˆ é™¤æ‰€æœ‰ app- å¼€å¤´çš„äº§ç‰©
          name: app-*
